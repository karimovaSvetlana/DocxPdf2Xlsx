# DocxPdf2Xlsx
[English](README.md) | **Русский**

Инструментарий для извлечения таблиц из документов DOCX и PDF с конвертацией в формат Excel с использованием vision-language моделей.

## Обзор

DocxPdf2Xlsx предоставляет два основных функционала:

1. **Извлечение таблиц из DOCX**: Извлечение всех таблиц из файлов DOCX и конвертация в формат Excel
2. **Извлечение таблиц из PDF**: Использование vision-language моделей (GLM-OCR или Qwen3-VL) для извлечения структурированных табличных данных из PDF документов через OCR

DOCX парсер может использоваться как самостоятельный инструмент, так и интегрироваться с Telegram ботом для удобного доступа пользователей.

## Возможности

- Автономная конвертация DOCX в Excel
- Telegram бот для извлечения таблиц из DOCX
- Конвертация PDF в Excel с использованием современных vision-language моделей
- Два варианта обработки PDF:
  - GLM-OCR: Легковесная модель для базового извлечения
  - Qwen3-VL: Продвинутая модель с параллельной обработкой и возможностью возобновления
- Автоматическая обработка многострочных записей в таблицах
- Утилиты для восстановления и очистки JSON для надежной обработки выходных данных LLM

## Установка

### Предварительные требования

- Python 3.10 или выше
- CUDA-совместимый GPU (рекомендуется для обработки PDF)
- Для конвертации PDF: poppler-utils

```bash
# Установка poppler на Ubuntu/Debian
sudo apt-get install poppler-utils

# Установка poppler на macOS
brew install poppler
```

### Установка зависимостей

```bash
pip install -r requirements.txt
```

## Использование

### DOCX в Excel (автономный режим)

Извлечение всех таблиц из DOCX файла:

```bash
python src/parsers/docx_parser.py input.docx output.xlsx
```

Или с использованием имени выходного файла по умолчанию (input.xlsx):

```bash
python src/parsers/docx_parser.py input.docx
```

### DOCX в Excel (Telegram бот)

1. Получите токен бота от [@BotFather](https://t.me/botfather)
2. Отредактируйте `src/bot/telegram_bot.py` и установите ваш токен:
   ```python
   TOKEN = "ваш_токен_бота"
   ```
3. Запустите бота:
   ```bash
   python src/bot/telegram_bot.py
   ```
4. Отправьте DOCX файл боту и получите Excel файл(ы) в ответ

### PDF в Excel (GLM-OCR)

Простое извлечение таблиц из PDF с использованием модели GLM-OCR:

```bash
python src/parsers/pdf_glm_ocr.py input.pdf output.xlsx
```

Это выполнит:
- Загрузку vision-language модели GLM-OCR
- Конвертацию каждой страницы PDF в изображение
- Извлечение структурированных табличных данных с помощью модели
- Сохранение результатов в Excel

### PDF в Excel (Qwen3-VL)

Продвинутая обработка PDF с параллельным выполнением и возможностью возобновления:

```bash
python src/parsers/pdf_qwen.py input.pdf output_directory prompt.txt
```

Возможности:
- Параллельная обработка страниц для ускорения выполнения
- Возобновляемая обработка (можно продолжить после прерывания)
- Логирование прогресса в формате JSONL
- Лучшая точность с моделью Qwen3-VL

Результат будет сохранен в `output_directory/<имя_pdf>/<имя_pdf>.xlsx`

## Структура проекта

```
DocxPdf2Xlsx/
├── src/
│   ├── parsers/           # Парсеры документов
│   │   ├── docx_parser.py # Извлечение таблиц из DOCX
│   │   ├── pdf_glm_ocr.py # Извлечение из PDF с GLM-OCR
│   │   └── pdf_qwen.py    # Извлечение из PDF с Qwen3-VL
│   ├── utils/             # Вспомогательные функции
│   │   └── json_utils.py  # Извлечение и очистка JSON
│   └── bot/               # Telegram бот
│       └── telegram_bot.py
├── data/
│   ├── input/             # Входные файлы
│   ├── output/            # Сгенерированные выходные данные
│   └── prompts/           # Шаблоны промптов для извлечения из PDF
├── requirements.txt       # Зависимости Python
└── README.md
```

## Как это работает

### Извлечение из DOCX

DOCX парсер использует библиотеку `python-docx` для:
1. Чтения всех таблиц из документа
2. Извлечения содержимого ячеек с сохранением структуры
3. Удаления дублирующихся строк
4. Объединения всех таблиц в один Excel файл

### Извлечение из PDF

Извлечение из PDF использует vision-language модели:

1. **Конвертация в изображения**: Страницы PDF конвертируются в изображения с помощью `pdf2image`
2. **Обработка моделью**: Каждое изображение страницы обрабатывается vision-language моделью со структурированным промптом
3. **Извлечение JSON**: Модель выдает табличные данные в формате JSON
4. **Очистка**: Несколько этапов очистки исправляют типичные ошибки форматирования LLM:
   - Экранирование кавычек в текстовых полях
   - Форматирование чисел (удаление пробелов, замена запятых на точки)
   - Удаление завершающих запятых
   - Автоматическое восстановление JSON
5. **Объединение**: Многострочные записи объединяются на основе наличия числовых данных
6. **Экспорт**: Финальные данные сохраняются в Excel

## Требования

### Основные зависимости

- pandas: Манипуляция данными и экспорт в Excel
- openpyxl: Запись Excel файлов
- python-docx: Парсинг DOCX файлов

### Обработка PDF

- torch: Фреймворк глубокого обучения
- transformers: Библиотека Hugging Face transformers
- pdf2image: Конвертация PDF в изображения
- pillow: Обработка изображений
- json-repair: Автоматическое восстановление JSON

### Telegram бот

- aiogram: Фреймворк для Telegram ботов

### Модели

- GLM-OCR: `zai-org/GLM-OCR`
- Qwen3-VL: `Qwen/Qwen3-VL-8B-Instruct`

Модели автоматически загружаются с Hugging Face при первом использовании.

## Советы и лучшие практики

### Для DOCX файлов

- Лучше всего работает с хорошо отформатированными таблицами
- Автоматически удаляет дублирующиеся строки
- Все таблицы объединяются в один выходной файл

### Для PDF файлов

- GLM-OCR быстрее, но менее точный
- Qwen3-VL обеспечивает лучшую точность за счет скорости и памяти
- Используйте Qwen3-VL для больших документов с функцией возобновления
- Настройте промпты в `data/prompts/` для вашей конкретной структуры таблиц
- Настоятельно рекомендуется GPU (совместимый с CUDA)
- Время обработки зависит от длины документа и используемой модели

### Общие

- Убедитесь в наличии достаточного дискового пространства для временных файлов
- Для больших PDF следите за использованием памяти GPU
- Проверяйте `raw_outputs.jsonl` для отладки проблем с извлечением

## Ограничения

- Извлечение из PDF требует GPU для приемлемой производительности
- Сложные макеты таблиц могут требовать настройки промптов
- Русские названия полей в схеме таблиц (можно настроить в промптах)
- Извлечение из PDF предполагает определенную структуру таблиц (бюджетные таблицы)

## Автор

Создано @svet_ds

## Лицензия

Этот проект предоставляется как есть для образовательных и исследовательских целей.
